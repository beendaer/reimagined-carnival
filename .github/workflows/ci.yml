# CI Pipeline - Python 3.11+ Support
# 
# Local Testing:
#   - Run tests: python -m unittest discover tests/ -v
#   - Run linters: flake8 src/ tests/ --max-line-length=120
#   - Run shellcheck: find scripts -name "*.sh" -exec shellcheck {} +
#   - Build Docker: docker build -t reimagined-carnival:local .
#
# CI Testing:
#   - Tests run on Python 3.11 and 3.12 matrix
#   - Flake8 linting with relaxed line length (120 chars)
#   - Security scanning with Trivy
#   - Docker build validation
#
name: CI Pipeline

permissions:
  contents: read

on:
  push:
    branches: [main, tooling/*, feature/*]
  pull_request:
    branches: [main]
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      - name: Install linters
        run: pip install shellcheck-py flake8 yamllint
      - name: Run shellcheck on scripts
        run: find scripts -name "*.sh" -exec shellcheck {} + 2>/dev/null || true
      - name: Run flake8 on Python code
        run: flake8 src/ tests/ --max-line-length=120 --extend-ignore=E501,W503 || true
  security:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v6
      - uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
  test:
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      - name: Run unit tests
        run: python -m unittest discover tests/ -v
  build:
    runs-on: ubuntu-latest
    needs: [lint, security, test]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: '3.12'
      - name: Build Docker image
        run: docker build -t reimagined-carnival:test .
